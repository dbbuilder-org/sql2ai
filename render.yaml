# Render Blueprint for SQL2.AI
# https://render.com/docs/blueprint-spec

services:
  # ===========================================
  # API Backend (FastAPI)
  # ===========================================
  - type: web
    name: sql2ai-api
    runtime: docker
    dockerfilePath: ./apps/api/Dockerfile
    dockerContext: .
    branch: main
    plan: starter
    healthCheckPath: /health
    envVars:
      - key: SQL2AI_ENVIRONMENT
        value: production
      - key: SQL2AI_DEBUG
        value: "false"
      - key: SQL2AI_DATABASE_URL
        fromDatabase:
          name: sql2ai-db
          property: connectionString
      - key: SQL2AI_SECRET_KEY
        generateValue: true
      - key: SQL2AI_CLERK_SECRET_KEY
        sync: false
      - key: SQL2AI_CLERK_PUBLISHABLE_KEY
        sync: false
      - key: SQL2AI_STRIPE_SECRET_KEY
        sync: false
      - key: SQL2AI_STRIPE_WEBHOOK_SECRET
        sync: false
      - key: SQL2AI_OPENAI_API_KEY
        sync: false
      - key: SQL2AI_ANTHROPIC_API_KEY
        sync: false
      - key: SQL2AI_SENTRY_DSN
        sync: false
      - key: SQL2AI_CORS_ORIGINS
        value: "https://app.sql2.ai,https://sql2.ai,http://localhost:3000"
    buildFilter:
      paths:
        - apps/api/**
        - libs/shared/**
    # Custom domain: api.sql2.ai

  # ===========================================
  # Dashboard App (Next.js)
  # ===========================================
  - type: web
    name: sql2ai-app
    runtime: node
    buildCommand: npm install && npx nx build app --prod
    startCommand: npx nx start app
    branch: main
    plan: starter
    healthCheckPath: /
    envVars:
      - key: NODE_ENV
        value: production
      - key: NEXT_PUBLIC_API_URL
        value: https://api.sql2.ai
      - key: NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY
        sync: false
      - key: CLERK_SECRET_KEY
        sync: false
      - key: NEXT_PUBLIC_SENTRY_DSN
        sync: false
    buildFilter:
      paths:
        - apps/app/**
        - libs/**
        - package.json
        - nx.json
    # Custom domain: app.sql2.ai

  # ===========================================
  # Marketing Site (Next.js Static Export)
  # ===========================================
  - type: static_site
    name: sql2ai-site
    buildCommand: npm install && bash apps/site/scripts/build.sh
    branch: main
    staticPublishPath: dist/apps/site/.next
    envVars:
      - key: NODE_ENV
        value: production
      - key: NODE_OPTIONS
        value: --max-old-space-size=1536
    buildFilter:
      paths:
        - apps/site/**
        - libs/**
        - package.json
        - nx.json
    headers:
      - path: /*
        name: X-Frame-Options
        value: DENY
    routes:
      - type: rewrite
        source: /*
        destination: /index.html
    # Custom domains: sql2.ai, www.sql2.ai

# ===========================================
# Databases
# ===========================================
databases:
  - name: sql2ai-db
    databaseName: sql2ai
    plan: starter
    postgresMajorVersion: "15"
