# SQL Migrator

**Module 2 of 8** | **Status:** In Development | **Priority:** P0

## Overview

SQL Migrator implements true database-first migrations where the schema is the source of truth. It generates typed code (Dapper, TypeScript) from your database, converts DACPAC projects to versioned migrations, and handles complex objects that other tools can't.

## Problems Solved

| Problem | Current Tool | SQL Migrator Solution |
|---------|--------------|----------------------|
| Code-first bias | Alembic, EF Migrations | Database is source of truth |
| No type generation | Flyway | Generates Dapper/TS types automatically |
| All-or-nothing deploys | DACPAC | Incremental versioned changes |
| Complex objects fail | Flyway | Full SP/trigger/dependency support |
| Manual Dapper models | Hand-coded | Auto-generated from schema |
| DACPAC limitations | sqlpackage | Convert to code migrations |
| Breaking change blindness | All | Explicit breaking change detection |

## Core Philosophy: Database-First

```
┌─────────────────────────────────────────────────────────────┐
│                    Traditional (Wrong)                       │
├─────────────────────────────────────────────────────────────┤
│  Code → ORM → Migrations → Database (afterthought)          │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                SQL Migrator (Database-First)                 │
├─────────────────────────────────────────────────────────────┤
│  Database → SQL Migrator → Generated Code → Application     │
│      │                          │                            │
│      └── Source of Truth        └── Dapper models            │
│                                     TypeScript types         │
│                                     API contracts            │
└─────────────────────────────────────────────────────────────┘
```

## Workflow

### 1. Capture Baseline
```bash
sql2ai migrate init --connection "Server=...;Database=MyDB"
# Creates baseline schema snapshot
# Initializes migration tracking table
```

### 2. Detect Changes
Developer makes changes in SSMS, Azure Data Studio, or any SQL tool.

```bash
sql2ai migrate diff
# Compares current schema against last snapshot
# Shows pending changes with impact analysis
```

Output:
```
Schema Changes Detected:

Tables:
  + Customers.LoyaltyTier (nvarchar(50), nullable)
  ~ Orders.Status: nvarchar(20) → nvarchar(50)

Procedures:
  ~ dbo.sp_ProcessOrder (modified)
  + dbo.sp_CalculateLoyalty (new)

Breaking Changes:
  ⚠ Orders.Status column size increase may affect indexes

Dependencies:
  sp_ProcessOrder → Customers, Orders
  sp_CalculateLoyalty → Customers
```

### 3. Generate Migration
```bash
sql2ai migrate generate --name "add-loyalty-program"
```

Creates:
```
migrations/
├── 20241224_001_add-loyalty-program/
│   ├── up.sql           # Forward migration
│   ├── down.sql         # Rollback script
│   ├── metadata.json    # Change metadata
│   └── checksum.sha256  # Content verification
```

### 4. Generate Code
```bash
sql2ai migrate codegen --target dapper
sql2ai migrate codegen --target typescript
```

## Code Generation

### Dapper Models (C#)

From this table:
```sql
CREATE TABLE Customers (
    CustomerID INT IDENTITY PRIMARY KEY,
    Email NVARCHAR(255) NOT NULL,
    Name NVARCHAR(100) NOT NULL,
    LoyaltyTier NVARCHAR(50) NULL,
    CreatedAt DATETIME2 NOT NULL DEFAULT GETUTCDATE()
);
```

Generates:
```csharp
// Auto-generated by SQL2.AI Migrator
// Source: dbo.Customers
// Generated: 2024-12-24T10:30:00Z

namespace MyApp.Data.Models;

public class Customer
{
    public int CustomerId { get; set; }
    public string Email { get; set; } = null!;
    public string Name { get; set; } = null!;
    public string? LoyaltyTier { get; set; }
    public DateTime CreatedAt { get; set; }
}
```

### Stored Procedure Wrappers

From this procedure:
```sql
CREATE PROCEDURE dbo.GetCustomersByTier
    @Tier NVARCHAR(50),
    @Limit INT = 100
AS
BEGIN
    SELECT CustomerID, Email, Name, LoyaltyTier
    FROM Customers
    WHERE LoyaltyTier = @Tier
    ORDER BY CreatedAt DESC
    OFFSET 0 ROWS FETCH NEXT @Limit ROWS ONLY;
END
```

Generates:
```csharp
// Auto-generated by SQL2.AI Migrator
public class CustomerRepository
{
    private readonly IDbConnection _connection;

    public CustomerRepository(IDbConnection connection)
    {
        _connection = connection;
    }

    public async Task<IEnumerable<Customer>> GetCustomersByTierAsync(
        string tier,
        int limit = 100)
    {
        return await _connection.QueryAsync<Customer>(
            "dbo.GetCustomersByTier",
            new { Tier = tier, Limit = limit },
            commandType: CommandType.StoredProcedure);
    }
}
```

### TypeScript Types

```typescript
// Auto-generated by SQL2.AI Migrator
// Source: dbo.Customers

export interface Customer {
  customerId: number;
  email: string;
  name: string;
  loyaltyTier: string | null;
  createdAt: Date;
}

export interface GetCustomersByTierParams {
  tier: string;
  limit?: number;
}
```

## DACPAC Conversion

### Problem with DACPAC
- All-or-nothing deployment
- No incremental versioning
- Complex merge conflicts
- Limited rollback support
- Opaque change tracking

### SQL Migrator Solution

```bash
sql2ai migrate import-dacpac --project ./MyDatabase.sqlproj
```

Converts DACPAC project to:
1. Baseline snapshot from current schema
2. Object-by-object version tracking
3. Incremental migration scripts
4. Proper dependency ordering
5. Generated rollback scripts

## Dependency Resolution

SQL Migrator understands object dependencies:

```
Dependency Graph:

  dbo.Orders ────────────────┐
       │                     │
       ▼                     ▼
  dbo.OrderItems      dbo.sp_ProcessOrder
       │                     │
       │                     │
       ▼                     ▼
  dbo.Products        dbo.fn_CalculateTax
```

Migrations are generated in correct order:
1. Tables first (by dependency order)
2. Functions (no dependencies on procedures)
3. Views (may depend on tables/functions)
4. Procedures (may depend on everything)
5. Triggers last

## Migration Execution

```bash
# Preview changes
sql2ai migrate apply --dry-run

# Apply to target
sql2ai migrate apply --target prod

# Rollback last migration
sql2ai migrate rollback

# Rollback to specific version
sql2ai migrate rollback --to 20241220_001
```

## API Endpoints

```
POST   /api/migrations/analyze      # Analyze schema changes
POST   /api/migrations/generate     # Generate migration from diff
POST   /api/migrations/apply        # Apply migration to target
POST   /api/migrations/rollback     # Rollback migration
GET    /api/migrations/history      # Get migration history
POST   /api/migrations/codegen      # Generate code from schema
POST   /api/migrations/import-dacpac
```

## Configuration

```yaml
# sql2ai.migrate.yaml
connection:
  default: "Server=localhost;Database=MyDB;Trusted_Connection=true"

migrations:
  directory: ./migrations
  table: __MigrationHistory

codegen:
  dapper:
    output: ./src/Data/Models
    namespace: MyApp.Data.Models
    generateRepositories: true

  typescript:
    output: ./src/types
    generateZodSchemas: true

options:
  generateRollback: true
  checksumVerification: true
  parallelExecution: false
```

## CLI Commands

```bash
sql2ai migrate init              # Initialize migration tracking
sql2ai migrate snapshot          # Capture current schema
sql2ai migrate diff              # Show pending changes
sql2ai migrate generate          # Generate migration file
sql2ai migrate apply             # Apply migrations
sql2ai migrate rollback          # Rollback last migration
sql2ai migrate codegen dapper    # Generate Dapper models
sql2ai migrate codegen typescript # Generate TS types
sql2ai migrate import-dacpac     # Import DACPAC project
sql2ai migrate validate          # Validate migrations
sql2ai migrate history           # Show migration history
```

## Implementation Status

- [ ] Core library structure (libs/migration-engine)
- [ ] Schema introspection (SQL Server)
- [ ] Schema introspection (PostgreSQL)
- [ ] Diff engine
- [ ] Migration generator
- [ ] Rollback generator
- [ ] Dapper code generator
- [ ] TypeScript code generator
- [ ] DACPAC parser/converter
- [ ] Dependency resolver
- [ ] API routers
- [ ] CLI commands
